# ç¶ ç•Œï¼ˆ**ECPay**ï¼‰

ç¶ ç•Œï¼ˆ**ECPay**ï¼‰æ˜¯å°ç£å¸¸è¦‹çš„ç·šä¸Šæ”¯ä»˜æœå‹™å¹³å°ï¼Œæ”¯æ´å¤šç¨®ä»˜æ¬¾æ–¹å¼ï¼ˆä¿¡ç”¨å¡ã€ATMã€è¶…å•†ä»£ç¢¼ã€LINE Pay ç­‰ï¼‰ã€‚å¦‚æœä½ æƒ³æŠŠ `displayActionMessage('Feature not ready yet :)')` æ”¹æˆ **çœŸæ­£ä¸²æ¥ç¶ ç•Œç·šä¸Šä»˜æ¬¾æµç¨‹**ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´æ•´åˆæ­¥é©Ÿï¼š

---

## âœ… ä¸²æ¥ç¶ ç•Œç·šä¸Šåˆ·å¡ï¼ˆä¿¡ç”¨å¡ï¼‰æµç¨‹ç¸½è¦½

1. **å‰ç«¯**æ”¶é›†ä»˜æ¬¾è³‡è¨Šä¸¦é€åˆ°å¾Œç«¯
2. **å¾Œç«¯ç”¢ç”Ÿç¶ ç•Œè¨‚å–®**ä¸¦å›å‚³ HTML form æˆ–ä»˜æ¬¾ç¶²å€
3. **å‰ç«¯å°å‘ç¶ ç•Œä»˜æ¬¾é **ï¼Œå®Œæˆä»˜æ¬¾
4. **ç¶ ç•Œä»˜æ¬¾å®Œæˆå¾Œå›å‚³çµæœè‡³å¾Œç«¯ï¼ˆcallback URLï¼‰**
5. **é¡¯ç¤ºä»˜æ¬¾çµæœé **

---

## âœ… 1. è¨­å®šç¶ ç•Œå¾Œç«¯ APIï¼ˆNode.js ç‚ºä¾‹ï¼‰

### ğŸ”§ å®‰è£ SDKï¼š

```bash
bash
è¤‡è£½ç·¨è¼¯
npm install ecpay-payment

```

### ğŸ”§ å»ºç«‹ API `/api/ecpay-checkout`

```
js
è¤‡è£½ç·¨è¼¯
// server/routes/ecpay.js
const express = require('express');
const router = express.Router();
const ecpay_payment = require('ecpay-payment');
const moment = require('moment');

router.post('/ecpay-checkout', (req, res) => {
  const { name, amount, email } = req.body;

  const base_param = {
    MerchantTradeNo: 'TEST' + Date.now(),
    MerchantTradeDate: moment().format('YYYY/MM/DD HH:mm:ss'),
    TotalAmount: amount,
    TradeDesc: 'Salinaka ç·šä¸Šè³¼ç‰©',
    ItemName: 'è¨‚å–®ä»˜æ¬¾ - ' + name,
    ReturnURL: 'https://ä½ çš„å¾Œç«¯/callback', // ç¶ ç•Œä»˜æ¬¾å®Œæˆé€šçŸ¥
    ClientBackURL: 'https://ä½ çš„å‰ç«¯/checkout/success', // ç”¨æˆ¶ä»˜æ¬¾å®Œæˆå°å›å‰ç«¯
    OrderResultURL: 'https://ä½ çš„å‰ç«¯/checkout/result',
    ChoosePayment: 'Credit',
    EncryptType: 1
  };

  const create = new ecpay_payment();
  const html = create.payment_client.aio_check_out_all(base_param, {
    MerchantID: '2000132',
    HashKey: 'ä½ çš„HashKey',
    HashIV: 'ä½ çš„HashIV',
    ClientBackURL: base_param.ClientBackURL
  });

  res.send({ html });
});

```

---

## âœ… 2. å‰ç«¯è§¸ç™¼ç¶ ç•Œä»˜æ¬¾æµç¨‹

### ğŸ§¾ æ›¿æ› `onConfirm`

```
js
è¤‡è£½ç·¨è¼¯
import axios from 'axios';

const onConfirm = async (values) => {
  try {
    const res = await axios.post('/api/ecpay-checkout', {
      name: values.name,
      amount: subtotal,
      email: 'test@example.com'
    });

    // å°‡å¾Œç«¯å›å‚³çš„ HTML form å¯«å…¥é é¢ä¸¦è‡ªå‹•æäº¤
    const newWindow = window.open();
    newWindow.document.write(res.data.html);
    newWindow.document.close();
  } catch (error) {
    displayActionMessage('ä»˜æ¬¾å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡', 'error');
  }
};

```

---

## âœ… 3. ç¶ ç•Œå¾Œç«¯å›èª¿é©—è­‰ï¼ˆéåŒæ­¥é€šçŸ¥ï¼‰

ç¶ ç•Œæœƒ POST è¨‚å–®è³‡è¨Šå›ä½ çš„ `/callback`ï¼Œä½ å¿…é ˆåœ¨å¾Œç«¯é©—è­‰ä¸¦è¨˜éŒ„ä»˜æ¬¾ç‹€æ…‹ã€‚

```
js
è¤‡è£½ç·¨è¼¯
router.post('/callback', (req, res) => {
  const { RtnCode, TradeAmt, MerchantTradeNo } = req.body;

  if (RtnCode === '1') {
    // ä»˜æ¬¾æˆåŠŸï¼Œæ›´æ–°è¨‚å–®ç‹€æ…‹
    console.log('ä»˜æ¬¾æˆåŠŸï¼', MerchantTradeNo);
  }

  res.send('1|OK'); // ç¶ ç•Œè¦å®šæˆåŠŸè™•ç†è¦å›å‚³é€™ä¸²
});

```

---

## âœ… 4. å‰ç«¯çµæœé è™•ç† `/checkout/success`

ä½ å¯ä»¥å°å¼•ç”¨æˆ¶åˆ°ä¸€å€‹æˆåŠŸé é¢ï¼Œé¡¯ç¤ºä»˜æ¬¾æˆåŠŸè³‡è¨Šï¼Œæˆ–ç”¨ç¶²å€åƒæ•¸é¡¯ç¤ºè¨‚å–®ç·¨è™Ÿã€‚

---

## âœ… å»ºè­°è£œå……ï¼š

- âœ… ç¶ ç•Œæ¸¬è©¦å•†åº—ä»£è™Ÿï¼š`2000132`
- âœ… æ¸¬è©¦é‡‘æµæ–‡ä»¶ï¼šhttps://developers.ecpay.com.tw/?p=6946

---

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ **Spring Boot æˆ–å…¶ä»–èªè¨€å¾Œç«¯**ï¼Œæˆ‘ä¹Ÿå¯ä»¥æä¾›ç›¸å°æ‡‰çš„ç¯„ä¾‹ã€‚ä½ å¸Œæœ›æˆ‘è£œå…… Node.js å¤–çš„å¾Œç«¯å¯¦ä½œå—ï¼Ÿé‚„æ˜¯è¦é€²ä¸€æ­¥æ•´åˆå…¶ä»–ä»˜æ¬¾æ–¹å¼ï¼ˆå¦‚è¶…å•†ã€ATMï¼‰ï¼Ÿ

4o

### ä½ èªªï¼š

Spring Boot

### ChatGPT èªªï¼š

å¥½çš„ï¼ä»¥ä¸‹æ˜¯ **æ•´åˆç¶ ç•Œé‡‘æµï¼ˆECPayï¼‰ä¿¡ç”¨å¡ä»˜æ¬¾**åˆ°ä½ ç¾æœ‰çš„ Spring Boot å°ˆæ¡ˆçš„å®Œæ•´æ•™å­¸ï¼Œè®“ä½ å¯ä»¥å–ä»£åŸæœ¬ `displayActionMessage('Feature not ready yet :)')`ï¼ŒçœŸæ­£å¯¦ç¾ç·šä¸Šæ”¯ä»˜ã€‚

---

## âœ… ä½¿ç”¨æµç¨‹ç¸½è¦½ï¼ˆSpring Boot å¾Œç«¯ï¼‰

1. å‰ç«¯é€å‡ºä»˜æ¬¾è³‡æ–™ï¼ˆä¾‹å¦‚å§“åã€é‡‘é¡ï¼‰çµ¦å¾Œç«¯
2. Spring Boot ç”¢ç”Ÿ ECPay è¨‚å–®è³‡æ–™èˆ‡ä»˜æ¬¾è¡¨å–®
3. å‰ç«¯æ¥æ”¶ä¸¦å°å‘ç¶ ç•Œä»˜æ¬¾é 
4. ç¶ ç•Œä»˜æ¬¾å®Œæˆå¾Œå›å‚³è³‡è¨Šè‡³å¾Œç«¯ï¼ˆcallback URLï¼‰
5. é¡¯ç¤ºæˆåŠŸæˆ–å¤±æ•—çµæœé é¢

---

## âœ… 1. åŠ å…¥å¿…è¦ä¾è³´

ç¶ ç•Œæ²’æä¾›å®˜æ–¹ Java SDKï¼Œå› æ­¤æˆ‘å€‘æœƒ **æ‰‹å‹•çµ„åˆåƒæ•¸ã€åŠ å¯†èˆ‡ç”¢ç”Ÿ HTML è¡¨å–®**ã€‚

```xml
xml
è¤‡è£½ç·¨è¼¯
<!-- pom.xml -->
<dependency>
    <groupId>commons-codec</groupId>
    <artifactId>commons-codec</artifactId>
    <version>1.15</version>
</dependency>

```

---

## âœ… 2. å»ºç«‹ä»˜æ¬¾è¡¨å–®ç”¢ç”Ÿå™¨

```java
java
è¤‡è£½ç·¨è¼¯
// ECPayService.java
import org.apache.commons.codec.digest.DigestUtils;
import org.springframework.stereotype.Service;
import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.text.SimpleDateFormat;
import java.util.*;

@Service
public class ECPayService {

    private final String merchantId = "2000132";
    private final String hashKey = "5294y06JbISpM5x9";
    private final String hashIV = "v77hoKGq4kWxNNIS";
    private final String returnURL = "https://ä½ çš„å¾Œç«¯/callback";
    private final String clientBackURL = "https://ä½ çš„å‰ç«¯/checkout/success";

    public String generateCheckoutForm(String name, int amount) {
        Map<String, String> params = new LinkedHashMap<>();
        String merchantTradeNo = "ORDER" + System.currentTimeMillis();

        params.put("MerchantID", merchantId);
        params.put("MerchantTradeNo", merchantTradeNo);
        params.put("MerchantTradeDate", new SimpleDateFormat("yyyy/MM/dd HH:mm:ss").format(new Date()));
        params.put("PaymentType", "aio");
        params.put("TotalAmount", String.valueOf(amount));
        params.put("TradeDesc", urlEncode("Salinaka ç·šä¸Šè³¼ç‰©"));
        params.put("ItemName", urlEncode(name + " è¨‚å–®ä»˜æ¬¾"));
        params.put("ReturnURL", returnURL);
        params.put("ClientBackURL", clientBackURL);
        params.put("ChoosePayment", "Credit");
        params.put("EncryptType", "1");

        // ç”¢ç”Ÿ CheckMacValue
        String checkMacValue = generateCheckMacValue(params);
        params.put("CheckMacValue", checkMacValue);

        // çµ„åˆ HTML form
        StringBuilder builder = new StringBuilder();
        builder.append("<form id='ecpay' method='POST' action='https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5'>");
        for (Map.Entry<String, String> entry : params.entrySet()) {
            builder.append("<input type='hidden' name='").append(entry.getKey()).append("' value='").append(entry.getValue()).append("'>");
        }
        builder.append("</form>");
        builder.append("<script>document.getElementById('ecpay').submit();</script>");
        return builder.toString();
    }

    private String generateCheckMacValue(Map<String, String> params) {
        StringBuilder sb = new StringBuilder("HashKey=" + hashKey);
        for (Map.Entry<String, String> entry : params.entrySet()) {
            sb.append("&").append(entry.getKey()).append("=").append(entry.getValue());
        }
        sb.append("&HashIV=").append(hashIV);

        String urlEncoded = urlEncode(sb.toString()).toLowerCase();
        return DigestUtils.md5Hex(urlEncoded).toUpperCase();
    }

    private String urlEncode(String value) {
        return URLEncoder.encode(value, StandardCharsets.UTF_8)
                .replace("+", "%20")
                .replace("*", "%2A")
                .replace("%7E", "~");
    }
}

```

---

## âœ… 3. Controller ç«¯é»

```java
java
è¤‡è£½ç·¨è¼¯
// CheckoutController.java
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api/checkout")
public class CheckoutController {

    @Autowired
    private ECPayService ecPayService;

    @PostMapping("/ecpay")
    public String ecpayCheckout(@RequestBody PaymentRequest request) {
        return ecPayService.generateCheckoutForm(request.getName(), request.getAmount());
    }

    // ç¶ ç•Œä»˜æ¬¾å®Œæˆé€šçŸ¥
    @PostMapping("/callback")
    public String ecpayCallback(@RequestParam Map<String, String> params) {
        // è™•ç†è¨‚å–®å®Œæˆ
        String rtnCode = params.get("RtnCode");
        String orderNo = params.get("MerchantTradeNo");
        if ("1".equals(rtnCode)) {
            System.out.println("è¨‚å–®ä»˜æ¬¾æˆåŠŸï¼š" + orderNo);
            // æ›´æ–°è³‡æ–™åº«è¨‚å–®ç‹€æ…‹ç‚ºå·²ä»˜æ¬¾
        }
        return "1|OK";
    }
}

```

```java
java
è¤‡è£½ç·¨è¼¯
// PaymentRequest.java
public class PaymentRequest {
    private String name;
    private int amount;

    // Getter & Setter
}

```

---

## âœ… 4. å‰ç«¯ä¿®æ”¹

å°‡ `onConfirm` æ”¹ç‚ºå‘¼å«ä¸Šè¿° API ä¸¦æ‰“é–‹ç¶ ç•Œè¡¨å–®ï¼š

```
js
è¤‡è£½ç·¨è¼¯
const onConfirm = async (values) => {
  try {
    const res = await axios.post('/api/checkout/ecpay', {
      name: values.name,
      amount: subtotal
    });

    const newWindow = window.open();
    newWindow.document.write(res.data);
    newWindow.document.close();
  } catch (error) {
    displayActionMessage('ä»˜æ¬¾å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡', 'error');
  }
};

```

---

## âœ… æ¸¬è©¦ç”¨åƒæ•¸ï¼ˆå¯ç”¨æ–¼ç¶ ç•Œæ¸¬è©¦ç’°å¢ƒï¼‰

- å•†åº—ä»£è™Ÿï¼ˆMerchantIDï¼‰ï¼š`2000132`
- HashKeyï¼š`5294y06JbISpM5x9`
- HashIVï¼š`v77hoKGq4kWxNNIS`
- æ¸¬è©¦ç¶²å€ï¼šhttps://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5

---

æ˜¯å¦ä¹Ÿéœ€è¦å¹«ä½ æ•´åˆè¶…å•†ä»£ç¢¼ã€ATM æˆ– LINE Payï¼Ÿé‚„æ˜¯ä½ åªæƒ³æ”¯æ´ä¿¡ç”¨å¡ï¼Ÿ

4o

### ä½ èªªï¼š

LINE Pay

### ChatGPT èªªï¼š

è‹¥ä½ å¸Œæœ›åœ¨ Spring Boot ä¸­ **æ•´åˆç¶ ç•Œçš„ LINE Pay æ”¯ä»˜åŠŸèƒ½**ï¼Œé€™æ˜¯å®Œå…¨å¯è¡Œçš„ï¼Œåªéœ€ç•¥ä½œä¿®æ”¹ç¶ ç•Œé‡‘æµçš„åƒæ•¸å³å¯ã€‚ä»¥ä¸‹å°‡ä»¥ä½ åŸæœ‰çš„æ•´åˆæµç¨‹ç‚ºåŸºç¤ï¼Œæ•™ä½ å¦‚ä½•æ”¯æ´ **LINE Pay æ”¯ä»˜æ–¹å¼**ã€‚

---

## âœ… LINE Pay æ”¯ä»˜æ•´åˆæµç¨‹

ç¶ ç•Œçš„ LINE Pay ä¹Ÿæ˜¯é€é `AioCheckOut` è¡¨å–®é€å‡ºï¼Œåªéœ€è¦æŠŠ `ChoosePayment` æ”¹ç‚º `"LINEPay"`ã€‚

---

## âœ… 1. ä¿®æ”¹ `ECPayService.java`

### åŠ å…¥æ–°çš„æ–¹æ³• `generateLinePayForm`

```java
java
è¤‡è£½ç·¨è¼¯
public String generateLinePayForm(String name, int amount) {
    Map<String, String> params = new LinkedHashMap<>();
    String merchantTradeNo = "LINEPAY" + System.currentTimeMillis();

    params.put("MerchantID", merchantId);
    params.put("MerchantTradeNo", merchantTradeNo);
    params.put("MerchantTradeDate", new SimpleDateFormat("yyyy/MM/dd HH:mm:ss").format(new Date()));
    params.put("PaymentType", "aio");
    params.put("TotalAmount", String.valueOf(amount));
    params.put("TradeDesc", urlEncode("LINEPay ç·šä¸Šä»˜æ¬¾"));
    params.put("ItemName", urlEncode(name + " è¨‚å–®ä»˜æ¬¾"));
    params.put("ReturnURL", returnURL);
    params.put("ClientBackURL", clientBackURL);
    params.put("ChoosePayment", "LINEPay");
    params.put("EncryptType", "1");

    String checkMacValue = generateCheckMacValue(params);
    params.put("CheckMacValue", checkMacValue);

    StringBuilder builder = new StringBuilder();
    builder.append("<form id='ecpay' method='POST' action='https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5'>");
    for (Map.Entry<String, String> entry : params.entrySet()) {
        builder.append("<input type='hidden' name='").append(entry.getKey()).append("' value='").append(entry.getValue()).append("'>");
    }
    builder.append("</form>");
    builder.append("<script>document.getElementById('ecpay').submit();</script>");
    return builder.toString();
}

```

---

## âœ… 2. ä¿®æ”¹ Controller

### æ–°å¢ LINE Pay çš„ç«¯é»

```java
java
è¤‡è£½ç·¨è¼¯
@PostMapping("/linepay")
public String linePayCheckout(@RequestBody PaymentRequest request) {
    return ecPayService.generateLinePayForm(request.getName(), request.getAmount());
}

```

---

## âœ… 3. å‰ç«¯æ•´åˆ

### å‡è¨­ä½ è¡¨å–®ä¸­æœ‰é¸æ“‡ä»˜æ¬¾æ–¹å¼çš„æ¬„ä½ï¼Œæ ¹æ“šä»˜æ¬¾æ–¹å¼å‘¼å«ä¸åŒç«¯é»ï¼š

```
js
è¤‡è£½ç·¨è¼¯
const onConfirm = async (values) => {
  try {
    const endpoint = values.type === 'linepay' ? '/api/checkout/linepay' : '/api/checkout/ecpay';
    const res = await axios.post(endpoint, {
      name: values.name,
      amount: subtotal
    });

    const newWindow = window.open();
    newWindow.document.write(res.data);
    newWindow.document.close();
  } catch (error) {
    displayActionMessage('ä»˜æ¬¾å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡', 'error');
  }
};

```

---

## âœ… è¡¨å–®ä¸­ä»˜æ¬¾æ–¹å¼ç¯„ä¾‹
```
jsx
è¤‡è£½ç·¨è¼¯
<Field as="select" name="type">
  <option value="credit">ä¿¡ç”¨å¡</option>
  <option value="linepay">LINE Pay</option>
</Field>
```
